{% extends "layouts/base.html" %}
{% block title %}Expert System - SariKidung{% endblock %}

{% block content %}

<header class="page-header animate">
    <span class="aksara-deco">ᬒᬁ</span>
    <span class="page-tag"><i class="fas fa-brain me-2"></i>Rule-Based Expert System</span>
    <h1>Konsultasi Kidung Panca Yadnya</h1>
    <p>Jawab pertanyaan berikut untuk menemukan Kidung yang tepat sesuai konteks upacara Anda.</p>
</header>

<div class="container my-5">
    <div class="row g-4 align-items-start">

        <!-- ══ PANEL KIRI: WIZARD ══ -->
        <div class="col-lg-5 animate">
            <div class="sk-card p-4" style="min-height:430px;">
                <h6 class="fw-bold mb-4 pb-2 border-bottom" style="color:var(--gold);font-family:'Poppins',sans-serif;text-transform:uppercase;letter-spacing:1.5px;font-size:.75rem;">
                    <i class="fas fa-question-circle me-2"></i>Konsultasi Pakar
                </h6>

                <!-- Progress -->
                <div class="mb-3" id="progress-wrap" style="display:none;">
                    <div class="d-flex justify-content-between mb-1" style="font-size:.78rem;color:var(--muted);">
                        <span id="step-label">Langkah 1</span>
                        <span id="step-fraction"></span>
                    </div>
                    <div class="progress" style="height:4px;border-radius:10px;background:var(--border);">
                        <div id="progress-bar" class="progress-bar" style="width:0%;background:var(--gold);transition:width .4s;"></div>
                    </div>
                </div>

                <!-- Pertanyaan -->
                <div id="question-area">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <p class="mb-0" id="step-indicator" style="font-size:.78rem;color:var(--muted);">Menyiapkan...</p>
                        <div class="spinner-border spinner-border-sm d-none" id="mini-loader" style="color:var(--gold);width:14px;height:14px;border-width:2px;"></div>
                    </div>
                    <h6 class="fw-bold mb-4" id="current-question-text" style="font-family:'Playfair Display';font-size:1.05rem;">Memuat pertanyaan...</h6>

                    <div id="hint-box" class="d-none alert py-2 px-3 mb-3" style="background:rgba(146,98,55,.06);border:1px solid rgba(146,98,55,.2);border-radius:8px;font-size:.78rem;color:var(--muted);">
                        <i class="fas fa-info-circle me-1" style="color:var(--gold);"></i>
                        <span id="hint-text"></span>
                    </div>

                    <div id="options-list" class="d-grid gap-2"></div>
                </div>

                <!-- Selesai -->
                <div id="finish-area" class="d-none text-center py-4">
                    <i class="fas fa-clipboard-check mb-3" style="font-size:3rem;color:var(--gold);opacity:.6;"></i>
                    <h6 class="fw-bold mb-2">Semua Jawaban Terkumpul!</h6>
                    <p class="text-muted mb-4" style="font-size:.83rem;">Klik tombol di bawah untuk memulai pencocokan dengan basis pengetahuan.</p>
                    <button onclick="submitToAI()" class="btn btn-bronze px-5 py-2 fw-bold">
                        <i class="fas fa-microchip me-2"></i>Mulai Analisis
                    </button>
                </div>

                <!-- Ringkasan -->
                <div id="summary-box" class="d-none mt-3 p-3 rounded-3" style="background:rgba(146,98,55,.05);border:1px solid rgba(146,98,55,.18);font-size:.8rem;">
                    <p class="fw-bold mb-2" style="color:var(--gold);font-size:.72rem;text-transform:uppercase;letter-spacing:1px;">
                        <i class="fas fa-list-check me-1"></i>Pilihan Anda
                    </p>
                    <div id="summary-content"></div>
                </div>

                <button onclick="resetWizard()" class="btn btn-sm btn-link p-0 mt-3 text-decoration-none" style="color:var(--muted);font-size:.78rem;">
                    <i class="fas fa-sync-alt me-1"></i>Mulai dari awal
                </button>
            </div>
        </div>

        <!-- ══ PANEL KANAN: HASIL ══ -->
        <div class="col-lg-7 position-relative" id="display-area">

            <!-- Loading overlay -->
            <div id="ai-loader" class="position-absolute top-0 start-0 w-100 h-100 flex-column align-items-center justify-content-center bg-white rounded-3"
                 style="z-index:10;opacity:.97;min-height:400px;display:none;border:1px solid var(--border);">
                <img src="https://cdn-icons-png.flaticon.com/512/10433/10433048.png" class="rotating-logo mb-3" style="width:64px;opacity:.7;">
                <h6 class="fw-bold animate-pulse" style="color:var(--gold);">MENYARING PENGETAHUAN PAKAR...</h6>
                <p class="text-muted" style="font-size:.8rem;">Mencocokkan dengan Ontologi Kidung Panca Yadnya</p>
            </div>

            <!-- Welcome -->
            <div id="welcome-msg" class="sk-card p-5 text-center d-flex flex-column justify-content-center align-items-center"
                 style="min-height:480px;border-style:dashed !important;">
                <div style="font-size:3rem;color:var(--gold);opacity:.15;margin-bottom:.75rem;">ᬒᬁ</div>
                <h6 class="text-muted mb-2">Selamat datang!</h6>
                <p class="text-muted fst-italic mb-4" style="font-size:.83rem;">Jawab pertanyaan di panel kiri untuk mulai konsultasi.</p>
                <div class="d-flex gap-4 text-center">
                    <div><div class="fw-bold" style="color:var(--gold);font-family:'Playfair Display';font-size:1.6rem;">74+</div><small class="text-muted" style="font-size:.72rem;">Koleksi Kidung</small></div>
                    <div><div class="fw-bold" style="color:var(--gold);font-family:'Playfair Display';font-size:1.6rem;">5</div><small class="text-muted" style="font-size:.72rem;">Jenis Yadnya</small></div>
                    <div><div class="fw-bold" style="color:var(--gold);font-family:'Playfair Display';font-size:1.6rem;">7</div><small class="text-muted" style="font-size:.72rem;">Tahap Upacara</small></div>
                </div>
            </div>

            <!-- Fallback -->
            <div id="fallback-msg" class="d-none sk-card p-4 rounded-3" style="border-left:4px solid #f59e0b !important;">
                <div class="d-flex gap-3 align-items-start">
                    <i class="fas fa-exclamation-triangle mt-1" style="color:#f59e0b;font-size:1.4rem;"></i>
                    <div>
                        <h6 class="fw-bold mb-1">Kidung Belum Tersedia</h6>
                        <p class="text-muted mb-3" id="fallback-text" style="font-size:.85rem;"></p>
                        <button onclick="resetWizard()" class="btn btn-sm btn-bronze">
                            <i class="fas fa-redo me-1"></i>Coba Konteks Lain
                        </button>
                    </div>
                </div>
            </div>

            <!-- Hasil -->
            <div id="result-box" class="d-none animate">
                <!-- Konteks -->
                <div class="p-3 mb-3 rounded-3 d-flex flex-wrap gap-2 align-items-center"
                     style="background:rgba(146,98,55,.06);border-left:3px solid var(--gold);">
                    <small class="fw-bold me-1" style="color:var(--gold);font-size:.72rem;">Konteks:</small>
                    <span id="badge-yadnya"  class="badge bg-white text-dark border shadow-sm" style="font-size:.72rem;"></span>
                    <span id="badge-upacara" class="badge bg-white text-dark border shadow-sm" style="font-size:.72rem;"></span>
                    <span id="badge-tahap"   class="badge bg-white text-dark border shadow-sm d-none" style="font-size:.72rem;"></span>
                    <span id="badge-pura"    class="badge bg-white text-dark border shadow-sm d-none" style="font-size:.72rem;"></span>
                    <span id="total-ditemukan" class="ms-auto text-muted" style="font-size:.76rem;"></span>
                </div>

                <!-- Penjelasan -->
                <div class="p-3 mb-3 rounded-3" style="background:#f0fff4;border-left:3px solid #28a745;">
                    <div class="d-flex gap-2 align-items-start">
                        <i class="fas fa-lightbulb mt-1 flex-shrink-0" style="color:#28a745;font-size:.9rem;"></i>
                        <div>
                            <small class="fw-bold d-block mb-1" style="color:#28a745;font-size:.68rem;text-transform:uppercase;letter-spacing:1px;">Mengapa kidung ini direkomendasikan?</small>
                            <p id="explanation-text" class="mb-0 text-muted" style="font-size:.82rem;"></p>
                        </div>
                    </div>
                </div>

                <div id="tahap-container"></div>

                <div class="d-flex gap-2 mt-3 flex-wrap">
                    <button onclick="window.print()" class="btn btn-sm btn-outline-secondary" style="font-size:.8rem;">
                        <i class="fas fa-print me-1"></i>Cetak
                    </button>
                    <button onclick="resetWizard()" class="btn btn-sm" style="font-size:.8rem;border:1.5px solid var(--gold);color:var(--gold);border-radius:6px;">
                        <i class="fas fa-redo me-1"></i>Konsultasi Baru
                    </button>
                    <a href="{{ url_for('questionnaire') }}" class="btn btn-sm btn-outline-secondary" style="font-size:.8rem;">
                        <i class="fas fa-comment me-1"></i>Beri Feedback
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.btn-option {
    background:#fff;border:1px solid var(--border);text-align:left;padding:.62rem 1rem;
    border-radius:8px;font-size:.85rem;transition:var(--transition);cursor:pointer;width:100%;color:var(--text);
}
.btn-option:hover { background:var(--gold-light);border-color:var(--gold);color:var(--gold);transform:translateX(3px); }
.btn-option.is-semua { border-style:dashed;border-color:var(--gold);color:var(--gold);font-weight:600;background:rgba(146,98,55,.03); }
.btn-option.is-semua:hover { background:rgba(146,98,55,.1); }
.tahap-card { border-left:3px solid var(--gold);border-radius:0 var(--radius) var(--radius) 0;margin-bottom:.8rem;background:#fff;box-shadow:var(--shadow-sm); }
.tahap-card.is-utama { border-left-color:#28a745;border-left-width:4px; }
.tahap-card.mode-single { border-left-width:4px; }
@media print {
    .navbar,footer,#question-area,#finish-area,.btn,#progress-wrap,#summary-box{display:none!important;}
    .card{box-shadow:none!important;border:1px solid #ddd!important;}
}
</style>

<script>
const SEMUA_TAHAP = "── Semua Tahap (Panduan Lengkap) ──";
const LABEL_MAP = { yadnya:'Yadnya', upacara:'Upacara', tahap:'Tahap', pura:'Pura' };
let userChoices = {}, selectionHistory = [];

async function initWizard() {
    userChoices = {}; selectionHistory = [];
    show('question-area'); hide('finish-area');
    hide('result-box'); hide('fallback-msg'); show('welcome-msg');
    hide('summary-box'); hide('hint-box');
    document.getElementById('progress-wrap').style.display = 'none';
    await getNextOptions();
}

async function getNextOptions() {
    setLoading(true);
    try {
        const res = await post('/get_filtered_options', userChoices);
        const data = await res.json();
        if (data.status === 'next') { renderButtons(data); }
        else { show('finish-area'); hide('question-area'); document.getElementById('progress-wrap').style.display='none'; renderSummary(); }
    } catch(e) { console.error(e); } finally { setLoading(false); }
}

function renderButtons(data) {
    const { options, next_feature:feat, step, total_steps:total, hint } = data;
    const container = document.getElementById('options-list');
    document.getElementById('current-question-text').textContent = data.label || `Pilih ${feat}:`;
    document.getElementById('step-indicator').textContent = `Pertanyaan ${step} dari ${total}`;
    const pw = document.getElementById('progress-wrap'); pw.style.display = 'block';
    document.getElementById('step-label').textContent    = `Pertanyaan ${step}`;
    document.getElementById('step-fraction').textContent = `${step} / ${total}`;
    document.getElementById('progress-bar').style.width  = `${Math.round((step/total)*100)}%`;
    if (hint) { document.getElementById('hint-text').textContent=hint; show('hint-box'); } else { hide('hint-box'); }
    container.innerHTML = '';
    if (Object.keys(userChoices).length > 0) {
        const back = document.createElement('button');
        back.className='btn btn-sm btn-link text-muted mb-2 p-0 text-decoration-none'; back.style.fontSize='.78rem';
        back.innerHTML='<i class="fas fa-arrow-left me-1"></i>Kembali'; back.onclick=goBack;
        container.appendChild(back);
    }
    options.forEach(opt => {
        const btn = document.createElement('button');
        const isSemua = opt === SEMUA_TAHAP;
        btn.className = `btn-option ${isSemua?'is-semua':''}`;
        const label = opt.replace(/_Ref/g,'').replace(/_/g,' ');
        btn.innerHTML = isSemua
            ? `<i class="fas fa-list-ol me-2"></i>${label}`
            : `<i class="fas fa-chevron-right me-2" style="font-size:.7rem;color:var(--gold);opacity:.5;"></i>${label}`;
        btn.onclick = () => { selectionHistory.push(feat); userChoices[feat]=opt; getNextOptions(); };
        container.appendChild(btn);
    });
}

function renderSummary() {
    show('summary-box');
    document.getElementById('summary-content').innerHTML = Object.entries(userChoices).map(([k,v]) => {
        const label = v.replace(/_Ref/g,'').replace(/_/g,' ');
        const isSemua = v === SEMUA_TAHAP;
        return `<div class="d-flex justify-content-between mb-1">
            <span class="text-muted" style="font-size:.79rem;">${LABEL_MAP[k]||k}:</span>
            <span class="fw-bold" style="color:var(--dark);font-size:.79rem;">
                ${isSemua?`<span style="color:var(--gold);">Panduan Lengkap</span>`:label}
            </span></div>`;
    }).join('');
}

function goBack() {
    if (selectionHistory.length > 0) {
        const last = selectionHistory.pop(); delete userChoices[last];
        show('question-area'); hide('finish-area'); hide('summary-box'); getNextOptions();
    }
}

async function submitToAI() {
    const loader = document.getElementById('ai-loader');
    hide('welcome-msg'); hide('result-box'); hide('fallback-msg');
    loader.style.display = 'flex';
    document.getElementById('finish-area').innerHTML = `<div class="py-3 text-center"><div class="spinner-border mb-2" style="color:var(--gold);width:1.5rem;height:1.5rem;border-width:2px;"></div><p class="text-muted" style="font-size:.8rem;">Menganalisis...</p></div>`;
    try {
        const res = await post('/predict', userChoices);
        if (!res.ok) throw new Error(`Server error: ${res.status}`);
        const data = await res.json();
        await delay(900);
        if (data.status === 'fallback') {
            document.getElementById('fallback-text').textContent = data.message;
            show('fallback-msg');
            document.getElementById('finish-area').innerHTML = `<i class="fas fa-exclamation-circle mb-2" style="font-size:2rem;color:#f59e0b;"></i><p class="text-muted" style="font-size:.8rem;">Tidak ditemukan. Coba konteks lain.</p><button onclick="resetWizard()" class="btn btn-sm btn-bronze mt-2"><i class="fas fa-redo me-1"></i>Coba Lagi</button>`;
        } else if (data.status === 'success') {
            renderResults(data); show('result-box');
            document.getElementById('finish-area').innerHTML = `<i class="fas fa-check-circle mb-2" style="font-size:2rem;color:#28a745;"></i><h6 class="fw-bold">Selesai!</h6><p class="text-muted mb-3" style="font-size:.8rem;">Hasil ditampilkan di panel kanan.</p><button onclick="resetWizard()" class="btn btn-sm btn-bronze"><i class="fas fa-redo me-1"></i>Konsultasi Baru</button>`;
        } else { alert(data.message||'Terjadi kesalahan.'); resetWizard(); }
    } catch(e) { console.error(e); alert(`Gagal terhubung.\n${e.message}`); resetWizard(); }
    finally { loader.style.display='none'; }
}

function renderResults(data) {
    const ctx = data.konteks || userChoices;
    const modeSemua = data.mode_semua_tahap;
    setBadge('badge-yadnya','Yadnya',ctx.yadnya);
    setBadge('badge-upacara','Upacara',ctx.upacara);
    if (ctx.tahap && ctx.tahap!=='None') { setBadge('badge-tahap','Tahap',ctx.tahap===SEMUA_TAHAP?'Semua Tahap':ctx.tahap); show('badge-tahap'); }
    if (ctx.pura  && ctx.pura !=='None') { setBadge('badge-pura','Pura',ctx.pura); show('badge-pura'); }
    const total = data.total_ditemukan||0;
    document.getElementById('total-ditemukan').textContent = modeSemua?`${total} kidung (semua tahap)`:`${total} kidung ditemukan`;
    document.getElementById('explanation-text').innerHTML = data.explanation||'';
    const container = document.getElementById('tahap-container');
    container.innerHTML = '';
    const kidungs = data.kidung_per_tahap||[];
    if (!kidungs.length) { container.innerHTML='<p class="text-muted fst-italic" style="font-size:.85rem;">Tidak ada kidung ditemukan.</p>'; return; }
    const sec = document.createElement('h6');
    sec.className='fw-bold mb-3'; sec.style.cssText='color:var(--gold);font-family:Poppins,sans-serif;font-size:.72rem;text-transform:uppercase;letter-spacing:1.5px;';
    sec.innerHTML = modeSemua?`<i class="fas fa-list-ol me-2"></i>Panduan Lengkap — ${kidungs.length} Kidung per Tahap`:`<i class="fas fa-scroll me-2"></i>Hasil Konsultasi`;
    container.appendChild(sec);
    kidungs.forEach((k,i) => {
        const isUtama=k.judul===data.judul; const isSingle=!modeSemua;
        const card = document.createElement('div');
        card.className=`card border-0 tahap-card ${isUtama&&modeSemua?'is-utama':''} ${isSingle?'mode-single':''}`;
        const validasi=k.status_validasi||'Belum Divalidasi';
        const vBadge = validasi==='Tervalidasi'
            ? `<span class="badge bg-success" style="font-size:.62rem;"><i class="fas fa-check-circle me-1"></i>${validasi}</span>`
            : `<span class="badge bg-warning text-dark" style="font-size:.62rem;"><i class="fas fa-clock me-1"></i>${validasi}</span>`;
        card.innerHTML=`
        <div class="card-header bg-white border-bottom py-2 px-3 d-flex justify-content-between align-items-center flex-wrap gap-1" style="border-radius:0 var(--radius) 0 0 !important;">
            <div class="fw-bold d-flex align-items-center gap-2" style="font-size:.8rem;">
                ${modeSemua?`<span class="badge" style="background:var(--gold);font-size:.62rem;">TAHAP ${i+1}</span><span class="text-uppercase">${esc(k.tahap||'-')}</span>`:
                            `<span class="badge bg-primary" style="font-size:.62rem;">Rekomendasi</span><span class="text-uppercase">${esc(k.tahap||'-')}</span>`}
                ${isUtama&&modeSemua?'<span class="badge bg-success" style="font-size:.62rem;">★ AI</span>':''}
            </div>${vBadge}
        </div>
        <div class="card-body p-3">
            <h6 class="fw-bold mb-2" style="font-family:'Playfair Display';font-size:1rem;">${esc(k.judul||'-')}</h6>
            <div class="d-flex gap-2 flex-wrap mb-3">
                ${k.jenis_sekar?`<span class="badge bg-light text-dark border" style="font-size:.7rem;">${esc(k.jenis_sekar)}</span>`:''}
                ${k.bahasa?`<span class="badge bg-light text-dark border" style="font-size:.7rem;">${esc(k.bahasa)}</span>`:''}
                ${k.pola_melodi&&k.pola_melodi!=='-'?`<span class="badge bg-light text-dark border" style="font-size:.7rem;"><i class="fas fa-music me-1" style="color:var(--gold);"></i>${esc(k.pola_melodi)}</span>`:''}
            </div>
            <div class="p-3 rounded-3 mb-3" style="background:var(--bg-soft);border:1px solid var(--border);">
                <p class="fw-bold mb-2" style="color:var(--gold);font-size:.68rem;text-transform:uppercase;letter-spacing:1px;font-family:Poppins,sans-serif;"><i class="fas fa-scroll me-1"></i>Teks Kidung</p>
                <div class="text-center lh-lg" style="white-space:pre-line;font-family:Georgia,serif;font-style:italic;font-size:.86rem;">${esc(k.teks||'Teks belum tersedia.')}</div>
            </div>
            <div class="p-3 rounded-3 mb-3" style="background:var(--dark);">
                <p class="fw-bold mb-2" style="color:var(--gold);font-size:.68rem;text-transform:uppercase;letter-spacing:1px;font-family:Poppins,sans-serif;"><i class="fas fa-lightbulb me-1"></i>Makna Mendalam</p>
                <p class="mb-0 opacity-85" style="color:rgba(255,255,255,.85);font-size:.83rem;text-align:justify;line-height:1.75;">${esc(k.makna_mendalam||k.makna||'Makna belum tersedia.')}</p>
            </div>
            <div class="p-3 rounded-3" style="background:rgba(146,98,55,.05);border:1px solid rgba(146,98,55,.14);">
                <p class="fw-bold mb-2" style="color:var(--gold);font-size:.68rem;text-transform:uppercase;letter-spacing:1px;font-family:Poppins,sans-serif;"><i class="fas fa-music me-1"></i>Teknik Menyanyi</p>
                <p class="mb-0 text-muted" style="font-size:.83rem;">${esc(k.teknik_menyanyi||'Teknik belum tersedia.')}</p>
            </div>
            ${k.has_audio ? renderAudioPlayer(k) : ''}
            ${k.sumber&&k.sumber!=='-'?`<p class="text-muted mt-2 mb-0" style="font-size:.78rem;"><i class="fas fa-book me-1"></i><strong>Sumber:</strong> ${esc(k.sumber)}</p>`:''}
        </div>`;
        container.appendChild(card);
    });
}

function renderAudioPlayer(k) {
    if (!k.has_audio || !k.embed_url) return '';
    const platform = k.platform_audio || '';
    let iframeHtml = '';
    if (platform === 'soundcloud') {
        iframeHtml = `<iframe width="100%" height="90" scrolling="no" frameborder="no" allow="autoplay"
            src="${k.embed_url}"></iframe>`;
    } else if (platform === 'youtube') {
        iframeHtml = `<iframe width="100%" height="200" src="${k.embed_url}"
            frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
            allowfullscreen></iframe>`;
    }
    if (!iframeHtml) return '';
    return `
    <div class="p-3 rounded-3 mt-3" style="background:rgba(146,98,55,.05);border:1px solid rgba(146,98,55,.2);">
        <p class="fw-bold mb-2" style="color:var(--gold);font-size:.68rem;text-transform:uppercase;letter-spacing:1px;font-family:Poppins,sans-serif;">
            <i class="fas fa-headphones me-1"></i>Dengarkan Kidung
            <span class="badge ms-1" style="background:${platform==='youtube'?'#f00':'#f50'};font-size:.58rem;text-transform:capitalize;">${platform}</span>
        </p>
        <div class="rounded-3 overflow-hidden">${iframeHtml}</div>
    </div>`;
}

function setBadge(id,label,val) {
    const el=document.getElementById(id); if(!el) return;
    const v=(val||'').replace(/── /g,'').replace(/ ──/g,'').replace(/_Ref/g,'').replace(/_/g,' ');
    el.innerHTML=`<b style="color:var(--gold);">${label}:</b> ${v}`;
}
function show(id){ document.getElementById(id)?.classList.remove('d-none'); }
function hide(id){ document.getElementById(id)?.classList.add('d-none'); }
function delay(ms){ return new Promise(r=>setTimeout(r,ms)); }
function setLoading(on){ const el=document.getElementById('mini-loader'); if(el) on?el.classList.remove('d-none'):el.classList.add('d-none'); }
function post(url,body){ return fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)}); }
function esc(str){ if(!str) return ''; return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function resetWizard(){ location.reload(); }
document.addEventListener('DOMContentLoaded', initWizard);
</script>
{% endblock %}