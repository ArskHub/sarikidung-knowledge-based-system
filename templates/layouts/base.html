<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}SariKidung - Sastra Suci Bali{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,700;1,700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    {% block extra_css %}{% endblock %}
</head>
<body>

<nav class="navbar navbar-expand-lg sticky-top bg-white border-bottom shadow-sm py-3">
    <div class="container">
        <a class="navbar-brand d-flex align-items-center" href="{{ url_for('home') }}">
            <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Logo" height="40" class="me-2"
                 onerror="this.src='https://cdn-icons-png.flaticon.com/512/10433/10433048.png'">
            <span class="logo-text">SARI<span>KIDUNG</span></span>
        </a>
        <button class="navbar-toggler border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto align-items-center gap-2">
                <li class="nav-item">
                    <a class="nav-link {{ 'active' if request.path == url_for('home') }}" href="{{ url_for('home') }}">
                        Home
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {{ 'active' if request.path == url_for('browsing') }}" href="{{ url_for('browsing') }}">
                        Expert System
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {{ 'active' if request.path == url_for('library') }}" href="{{ url_for('library') }}">
                        Library
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {{ 'active' if request.path == url_for('questionnaire') }}" href="{{ url_for('questionnaire') }}">
                        Feedback
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {{ 'active' if request.path == url_for('about') }}" href="{{ url_for('about') }}">
                        About
                    </a>
                </li>
                <li class="nav-item ms-lg-3">
                    <a href="{{ url_for('browsing') }}" class="btn btn-bronze px-4 py-2 fw-bold">
                        <i class="fas fa-search me-1"></i>KONSULTASI
                    </a>
                </li>
                <!-- Tombol Chat AI sebelah kanan KONSULTASI -->
                <li class="nav-item position-relative">
                    <button onclick="toggleNavChat()" id="nav-chat-btn"
                            class="btn px-3 py-2 fw-bold d-flex align-items-center gap-2"
                            style="background:#fff; border:2px solid var(--gold); color:var(--gold);
                                   border-radius:8px; transition:all .2s; position:relative;">
                        <i class="fas fa-comment-dots"></i>
                        <span class="d-none d-lg-inline" style="font-size:.85rem;">Chat</span>
                        <span id="nav-chat-notif"
                              style="display:none; width:8px; height:8px; background:#e74c3c;
                                     border-radius:50%; position:absolute; top:5px; right:5px;"></span>
                    </button>

                    <!-- Panel chat dropdown dari navbar -->
                    <div id="nav-chat-panel"
                         style="display:none; position:absolute; top:calc(100% + 12px); right:0;
                                width:360px; border-radius:16px; z-index:2000;
                                box-shadow:0 8px 40px rgba(0,0,0,.18); overflow:hidden;
                                flex-direction:column; background:#fff;
                                border:1px solid rgba(146,98,55,.2);">

                        <!-- Header -->
                        <div style="background:var(--gold); padding:12px 16px;
                                    display:flex; align-items:center; justify-content:space-between;">
                            <div class="d-flex align-items-center gap-2">
                                <div style="width:32px;height:32px;border-radius:50%;
                                            background:rgba(255,255,255,.2);
                                            display:flex;align-items:center;justify-content:center;">
                                    <i class="fas fa-robot text-white small"></i>
                                </div>
                                <div>
                                    <div style="color:#fff;font-weight:700;font-size:.9rem;line-height:1.2;">SariBot</div>
                                    <div style="color:rgba(255,255,255,.8);font-size:.7rem;">
                                        <span style="display:inline-block;width:7px;height:7px;
                                                     background:#4ade80;border-radius:50%;margin-right:4px;"></span>
                                        Khusus Kidung & Upacara Bali
                                    </div>
                                </div>
                            </div>
                            <div class="d-flex gap-2">
                                <button onclick="clearNavChat()" title="Hapus riwayat"
                                        style="background:rgba(255,255,255,.15);border:none;color:#fff;
                                               border-radius:6px;padding:4px 8px;cursor:pointer;font-size:.75rem;">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                                <button onclick="toggleNavChat()" title="Tutup"
                                        style="background:rgba(255,255,255,.15);border:none;color:#fff;
                                               border-radius:6px;padding:4px 8px;cursor:pointer;font-size:.75rem;">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Pesan -->
                        <div id="nav-chat-messages"
                             style="overflow-y:auto; padding:14px; background:#fafafa; height:300px;">
                            <div class="d-flex gap-2 mb-3">
                                <div style="width:28px;height:28px;border-radius:50%;background:var(--gold);
                                            display:flex;align-items:center;justify-content:center;
                                            flex-shrink:0;align-self:flex-end;">
                                    <i class="fas fa-robot text-white" style="font-size:.6rem;"></i>
                                </div>
                                <div style="background:#fff;border:1px solid #e8e0d8;border-radius:12px;
                                            padding:10px 12px;font-size:.82rem;max-width:85%;line-height:1.5;">
                                    Rahajeng! üôè Tanya apa saja seputar <strong>Kidung & upacara Bali</strong>.
                                </div>
                            </div>
                        </div>

                        <!-- Saran -->
                        <div id="nav-chat-suggestions"
                             style="padding:8px 12px;border-top:1px solid #f0e8de;
                                    background:#fff;display:flex;flex-wrap:wrap;gap:6px;">
                            <button onclick="setNavQ('Apa itu Kidung Wargasari?')"
                                    style="font-size:.7rem;padding:3px 10px;border:1px solid rgba(146,98,55,.3);
                                           color:var(--gold);border-radius:20px;background:rgba(146,98,55,.05);cursor:pointer;">
                                Kidung Wargasari?
                            </button>
                            <button onclick="setNavQ('Kidung apa untuk Ngaben?')"
                                    style="font-size:.7rem;padding:3px 10px;border:1px solid rgba(146,98,55,.3);
                                           color:var(--gold);border-radius:20px;background:rgba(146,98,55,.05);cursor:pointer;">
                                Kidung Ngaben?
                            </button>
                            <button onclick="setNavQ('Bedanya Sekar Alit dan Sekar Madya?')"
                                    style="font-size:.7rem;padding:3px 10px;border:1px solid rgba(146,98,55,.3);
                                           color:var(--gold);border-radius:20px;background:rgba(146,98,55,.05);cursor:pointer;">
                                Sekar Alit vs Madya?
                            </button>
                        </div>

                        <!-- Input -->
                        <div style="padding:10px 12px;border-top:1px solid #eee;
                                    background:#fff;display:flex;gap:8px;">
                            <input id="nav-chat-input" type="text"
                                   placeholder="Ketik pertanyaan..."
                                   onkeydown="if(event.key==='Enter'){event.preventDefault();sendNavChat();}"
                                   style="flex:1;border:1px solid #dee2e6;border-radius:10px;
                                          padding:8px 12px;font-size:.82rem;outline:none;">
                            <button onclick="sendNavChat()" id="nav-send-btn"
                                    style="background:var(--gold);border:none;color:#fff;
                                           border-radius:10px;padding:8px 12px;cursor:pointer;font-size:.82rem;">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </li>
            </ul>
        </div>
    </div>
</nav>

<main>
    {% block content %}{% endblock %}
</main>

<footer class="mt-5">
    <div class="container py-5">
        <div class="row g-4">
            <div class="col-lg-4">
                <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Logo" height="50" class="mb-3"
                     onerror="this.src='https://cdn-icons-png.flaticon.com/512/10433/10433048.png'">
                <h5 class="logo-text-footer mb-3">SARI<span>KIDUNG</span> BALI</h5>
                <p class="text-muted small lh-lg">Pelestarian Sastra Suci Kidung Panca Yadnya Bali melalui pendekatan sistem pakar dan digitalisasi budaya.</p>
                <div class="d-flex gap-3 mt-3">
                    <a href="#" class="text-bronze fs-4"><i class="fab fa-instagram"></i></a>
                    <a href="#" class="text-bronze fs-4"><i class="fab fa-youtube"></i></a>
                </div>
            </div>
            <div class="col-6 col-lg-2 ms-lg-auto">
                <h6 class="footer-title">Navigasi</h6>
                <ul class="list-unstyled footer-links">
                    <li><a href="{{ url_for('home') }}">Home</a></li>
                    <li><a href="{{ url_for('browsing') }}">Expert System</a></li>
                    <li><a href="{{ url_for('library') }}">Library</a></li>
                    <li><a href="{{ url_for('questionnaire') }}">Feedback</a></li>
                    <li><a href="{{ url_for('about') }}">About</a></li>
                </ul>
            </div>
            <div class="col-6 col-lg-2">
                <h6 class="footer-title">Panca Yadnya</h6>
                <ul class="list-unstyled footer-links text-muted small">
                    <li><i class="fas fa-om me-2 text-bronze"></i>Dewa Yadnya</li>
                    <li><i class="fas fa-om me-2 text-bronze"></i>Pitra Yadnya</li>
                    <li><i class="fas fa-om me-2 text-bronze"></i>Manusa Yadnya</li>
                    <li><i class="fas fa-om me-2 text-bronze"></i>Bhuta Yadnya</li>
                    <li><i class="fas fa-om me-2 text-bronze"></i>Rsi Yadnya</li>
                </ul>
            </div>
            <div class="col-lg-3">
                <h6 class="footer-title">Hubungi Kami</h6>
                <p class="text-muted small mb-2"><i class="fas fa-map-marker-alt me-2 text-bronze"></i>Denpasar, Bali</p>
                <p class="text-muted small"><i class="fas fa-envelope me-2 text-bronze"></i>info@sarikidung.com</p>
            </div>
        </div>
        <hr class="my-5 opacity-10">
        <div class="text-center text-muted small pb-4 letter-spacing-1">
            &copy; 2026 SARIKIDUNG BALI. DIGITALIZATION OF BALINESE SACRED LITERATURE.
        </div>
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="{{ url_for('static', filename='js/script.js') }}"></script>
{% block extra_js %}{% endblock %}
</body>
</html>
<style>
#nav-chat-btn:hover { background: rgba(146,98,55,.08) !important; }
.nav-bubble-typing-dot {
    width:6px; height:6px; border-radius:50%; background:#aaa;
    display:inline-block; animation: nbTyping .8s infinite;
}
.nav-bubble-typing-dot:nth-child(2) { animation-delay:.15s; }
.nav-bubble-typing-dot:nth-child(3) { animation-delay:.3s; }
@keyframes nbTyping { 0%,60%,100%{transform:translateY(0);} 30%{transform:translateY(-5px);} }
</style>

<script>
let navChatHistory = [];
let navChatOpen    = false;

function toggleNavChat() {
    navChatOpen = !navChatOpen;
    const panel = document.getElementById('nav-chat-panel');
    const notif = document.getElementById('nav-chat-notif');
    panel.style.display = navChatOpen ? 'flex' : 'none';
    if (navChatOpen) {
        notif.style.display = 'none';
        setTimeout(() => document.getElementById('nav-chat-input')?.focus(), 100);
    }
}

// Tutup panel kalau klik di luar
document.addEventListener('click', function(e) {
    const panel = document.getElementById('nav-chat-panel');
    const btn   = document.getElementById('nav-chat-btn');
    if (navChatOpen && panel && !panel.contains(e.target) && !btn.contains(e.target)) {
        navChatOpen = false;
        panel.style.display = 'none';
    }
});

function setNavQ(q) {
    document.getElementById('nav-chat-input').value = q;
    document.getElementById('nav-chat-input').focus();
    document.getElementById('nav-chat-suggestions').style.display = 'none';
}

function clearNavChat() {
    navChatHistory = [];
    document.getElementById('nav-chat-messages').innerHTML = `
        <div class="d-flex gap-2 mb-3">
            <div style="width:28px;height:28px;border-radius:50%;background:var(--gold);
                        display:flex;align-items:center;justify-content:center;flex-shrink:0;align-self:flex-end;">
                <i class="fas fa-robot text-white" style="font-size:.6rem;"></i>
            </div>
            <div style="background:#fff;border:1px solid #e8e0d8;border-radius:12px;
                        padding:10px 12px;font-size:.82rem;max-width:85%;line-height:1.5;">
                Riwayat dihapus. Rahajeng! üôè Silakan tanya lagi.
            </div>
        </div>`;
    document.getElementById('nav-chat-suggestions').style.display = 'flex';
}

async function sendNavChat() {
    const input = document.getElementById('nav-chat-input');
    const pesan = input.value.trim();
    if (!pesan) return;

    input.value = '';
    input.disabled = true;
    document.getElementById('nav-send-btn').disabled = true;
    document.getElementById('nav-chat-suggestions').style.display = 'none';

    appendNavMsg('user', pesan);
    navChatHistory.push({ role: 'user', text: pesan });

    const typingId = appendNavTyping();

    try {
        const res  = await fetch('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: pesan, history: navChatHistory.slice(0, -1) })
        });
        const data = await res.json();
        removeNavEl(typingId);

        const reply = data.reply || 'Maaf, tidak ada respons.';
        appendNavMsg('bot', reply);

        if (data.status === 'success') {
            navChatHistory.push({ role: 'bot', text: reply });
            if (navChatHistory.length > 20) navChatHistory = navChatHistory.slice(-20);
        }

        // Kalau panel tertutup, tampilkan notif dot
        if (!navChatOpen) {
            document.getElementById('nav-chat-notif').style.display = 'block';
        }

    } catch(e) {
        removeNavEl(typingId);
        appendNavMsg('bot', 'Maaf, gagal terhubung. Coba lagi.');
    } finally {
        input.disabled = false;
        document.getElementById('nav-send-btn').disabled = false;
        input.focus();
    }
}

function appendNavMsg(role, text) {
    const msgs  = document.getElementById('nav-chat-messages');
    const isBot = role === 'bot';
    const div   = document.createElement('div');
    div.className = `d-flex gap-2 mb-2 ${isBot ? '' : 'flex-row-reverse'}`;

    const formatted = text
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/\n/g, '<br>');

    div.innerHTML = `
        <div style="width:26px;height:26px;border-radius:50%;background:${isBot?'var(--gold)':'#e0e0e0'};
                    display:flex;align-items:center;justify-content:center;flex-shrink:0;align-self:flex-end;">
            <i class="fas fa-${isBot?'robot':'user'} ${isBot?'text-white':'text-muted'}" style="font-size:.55rem;"></i>
        </div>
        <div style="background:${isBot?'#fff':'var(--gold)'};color:${isBot?'var(--dark)':'#fff'};
                    border:${isBot?'1px solid #e8e0d8':'none'};border-radius:12px;
                    padding:9px 11px;font-size:.8rem;max-width:82%;line-height:1.5;">
            ${formatted}
        </div>`;

    msgs.appendChild(div);
    msgs.scrollTop = msgs.scrollHeight;
}

function appendNavTyping() {
    const msgs = document.getElementById('nav-chat-messages');
    const id   = 'nt-' + Date.now();
    const div  = document.createElement('div');
    div.id     = id;
    div.className = 'd-flex gap-2 mb-2';
    div.innerHTML = `
        <div style="width:26px;height:26px;border-radius:50%;background:var(--gold);
                    display:flex;align-items:center;justify-content:center;flex-shrink:0;align-self:flex-end;">
            <i class="fas fa-robot text-white" style="font-size:.55rem;"></i>
        </div>
        <div style="background:#fff;border:1px solid #e8e0d8;border-radius:12px;
                    padding:10px 14px;display:flex;gap:4px;align-items:center;">
            <span class="nav-bubble-typing-dot"></span>
            <span class="nav-bubble-typing-dot"></span>
            <span class="nav-bubble-typing-dot"></span>
        </div>`;
    msgs.appendChild(div);
    msgs.scrollTop = msgs.scrollHeight;
    return id;
}

function removeNavEl(id) { document.getElementById(id)?.remove(); }
</script>